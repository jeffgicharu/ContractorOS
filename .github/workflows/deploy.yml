name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      seed:
        description: 'Run database seed after migration'
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  ci:
    name: CI Checks
    uses: ./.github/workflows/ci.yml

  deploy:
    name: Deploy to VPS
    needs: ci
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        env:
          NEXT_PUBLIC_API_URL: https://contractoros.jeffgicharu.com/api/v1
        run: pnpm build

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Rsync to VPS
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key" \
            --include='apps/' \
            --include='apps/api/' \
            --include='apps/api/dist/***' \
            --include='apps/api/package.json' \
            --include='apps/api/src/' \
            --include='apps/api/src/database/' \
            --include='apps/api/src/database/migrations/***' \
            --include='apps/api/src/database/seeds/***' \
            --include='apps/api/src/config/***' \
            --include='apps/web/' \
            --include='apps/web/.next/***' \
            --include='apps/web/public/***' \
            --include='apps/web/package.json' \
            --include='apps/web/next.config.mjs' \
            --include='packages/***' \
            --include='package.json' \
            --include='pnpm-lock.yaml' \
            --include='pnpm-workspace.yaml' \
            --include='ecosystem.config.cjs' \
            --include='tsconfig.base.json' \
            --exclude='*' \
            ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ secrets.DEPLOY_PATH }}/current/

      - name: Install deps, migrate, restart
        uses: appleboy/ssh-action@v1
        env:
          SEED: ${{ github.event.inputs.seed }}
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: SEED
          script: |
            set -e
            cd ${{ secrets.DEPLOY_PATH }}/current

            # Symlink env files for dotenv
            ln -sf ${{ secrets.DEPLOY_PATH }}/.env.api apps/api/.env
            ln -sf ${{ secrets.DEPLOY_PATH }}/.env.web apps/web/.env

            # Install production dependencies
            pnpm install --frozen-lockfile --prod

            # Run database migrations
            set -a && source ${{ secrets.DEPLOY_PATH }}/.env.api && set +a
            pnpm --filter @contractor-os/api migrate:up

            # Seed database (only when triggered manually with seed=true)
            if [ "$SEED" = "true" ]; then
              echo "Running database seed..."
              pnpm --filter @contractor-os/api seed
            fi

            # Restart PM2 processes
            pm2 startOrRestart ecosystem.config.cjs --env production
            pm2 save
