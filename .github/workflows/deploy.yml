name: Deploy

on:
  push:
    branches: [main]

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  ci:
    name: CI Checks
    uses: ./.github/workflows/ci.yml

  deploy:
    name: Deploy to VPS
    needs: ci
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        env:
          NEXT_PUBLIC_API_URL: https://contractoros.jeffgicharu.com/api/v1
        run: pnpm build

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H REDACTED_HOST >> ~/.ssh/known_hosts

      - name: Rsync to VPS
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key" \
            --include='apps/' \
            --include='apps/api/' \
            --include='apps/api/dist/***' \
            --include='apps/api/package.json' \
            --include='apps/api/src/' \
            --include='apps/api/src/database/' \
            --include='apps/api/src/database/migrations/***' \
            --include='apps/web/' \
            --include='apps/web/.next/***' \
            --include='apps/web/public/***' \
            --include='apps/web/package.json' \
            --include='apps/web/next.config.ts' \
            --include='packages/***' \
            --include='package.json' \
            --include='pnpm-lock.yaml' \
            --include='pnpm-workspace.yaml' \
            --include='ecosystem.config.cjs' \
            --include='tsconfig.base.json' \
            --exclude='*' \
            ./ deploy@REDACTED_HOST:/REDACTED_PATH/current/

      - name: Install deps, migrate, restart
        uses: appleboy/ssh-action@v1
        with:
          host: REDACTED_HOST
          username: deploy
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            cd /REDACTED_PATH/current

            # Install production dependencies
            pnpm install --frozen-lockfile --prod

            # Run database migrations
            set -a && source /REDACTED_PATH/.env.api && set +a
            pnpm --filter @contractor-os/api migrate:up

            # Restart PM2 processes
            pm2 startOrRestart ecosystem.config.cjs --env production
            pm2 save
